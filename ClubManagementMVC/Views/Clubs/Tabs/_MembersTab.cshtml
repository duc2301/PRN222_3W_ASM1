@using ClubManagement.Service.DTOs.ResponseDTOs
@model ClubMembersPageViewModel

<style>
    .edit-member-modal {
        border-radius: 16px;
        overflow: hidden;
        border: none;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.25);
    }

    .edit-member-header {
        padding: 16px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .edit-member-header h5 {
            margin: 0;
            font-weight: 600;
            font-size: 18px;
        }

    .edit-member-body {
        padding: 20px 24px;
    }

    .edit-member-footer {
        padding: 16px 24px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .edit-member-card {
        border-radius: 12px;
        background: #f9fafb;
        padding: 14px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
    }

    .edit-member-avatar {
        width: 48px;
        height: 48px;
        border-radius: 999px;
        background: #e5edff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #4c51bf;
        font-size: 18px;
    }

    .edit-member-name {
        font-weight: 600;
        font-size: 16px;
    }

    .edit-member-meta {
        font-size: 13px;
        color: #6b7280;
    }

    .btn-danger-link {
        background: none;
        border: none;
        color: #e11d48;
        font-weight: 500;
        padding: 0;
    }

    .member-avatar {
        width: 36px;
        height: 36px;
        border-radius: 999px;
        background: #edf2ff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #4c6fff;
        margin-right: 10px;
        font-size: 14px;
    }

    .member-name {
        font-weight: 600;
        font-size: 14px;
    }

    .member-email {
        font-size: 12px;
        color: #6c757d;
    }

    .badge-status {
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 999px;
    }

        .badge-status.active {
            background: #e6ffed;
            color: #2f855a;
        }

        .badge-status.banned {
            background: #ffe4e6;
            color: #e53e3e;
        }

        .badge-status.inactive {
            background: #e5e7eb;
            color: #4b5563;
        }
</style>

<!-- Form search + filter -->
<form method="get"
      asp-action="Details"
      asp-controller="Clubs"
      class="member-filters">

    <input type="hidden" name="id" value="@Model.Club.ClubId" />

    <div class="flex-grow-1">
        <div class="input-group">
            <span class="input-group-text bg-white border-end-0">
                <i class="bi bi-search"></i>
            </span>
            <input type="text"
                   name="search"
                   value="@Model.Search"
                   class="form-control border-start-0"
                   placeholder="Tìm tên, MSSV, email...">
        </div>
    </div>

    <div>
        <select class="form-select" name="roleFilter">
            <option value="">Tất cả vai trò</option>

            <option value="Leader"
                    selected="@(Model.RoleFilter == "Leader")">
                Leader
            </option>

            <option value="Member"
                    selected="@(Model.RoleFilter == "Member")">
                Member
            </option>

            <option value="Treasurer"
                    selected="@(Model.RoleFilter == "Treasurer")">
                Treasurer
            </option>
        </select>

    </div>

    <div>
        <select class="form-select" name="statusFilter">
            <option value="">Tất cả trạng thái</option>

            <option value="Active"
                    selected="@(Model.StatusFilter == "Active")">
                Active
            </option>

            <option value="Inactive"
                    selected="@(Model.StatusFilter == "Inactive")">
                Inactive
            </option>

            <option value="Banned"
                    selected="@(Model.StatusFilter == "Banned")">
                Banned
            </option>
        </select>

    </div>

    <div>
        <button type="submit" class="btn btn-outline-secondary btn-filter">
            Lọc
        </button>
    </div>

    @* <div class="ms-auto">
        <button type="button" class="btn btn-dark btn-add-member">
            <i class="bi bi-plus-lg me-1"></i> Thêm thành viên
        </button>
    </div> *@
</form>

<!-- Bảng thành viên -->
<div class="member-table">
    <table class="table align-middle mb-0">
        <thead>
            <tr>
                <th class="ps-4" style="width: 60px;">STT</th>
                <th>Thành viên</th>
                <th>Khoa</th>
                <th>Vai trò</th>
                <th>Trạng thái</th>
                <th>Ngày tham gia</th>
                <th class="text-end pe-4">Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Members == null || !Model.Members.Any())
            {
                <tr>
                    <td colspan="8" class="text-center py-4 text-muted">
                        Không có thành viên nào.
                    </td>
                </tr>
            }
            else
            {
                var sttBase = (Model.Page - 1) * Model.PageSize;
                var index = 0;

                foreach (var m in Model.Members)
                {
                    var stt = sttBase + (++index);
                    var avatarChar = !string.IsNullOrWhiteSpace(m.FullName)
                    ? m.FullName.Trim()[0].ToString().ToUpper()
                    : "M";

                    <tr>
                        <td class="ps-4">@stt</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="member-avatar">@avatarChar</div>
                                <div>
                                    <div class="member-name">@m.FullName</div>
                                    <div class="member-email">@m.Email</div>
                                </div>
                            </div>
                        </td>

                        <td>@m.Department</td>
                        <td>@m.Role</td>
                        <td>
                            @{
                                var status = m.Status?.ToLower();
                            }
                            @if (status == "banned")
                            {
                                <span class="badge-status banned">Banned</span>
                            }
                            else if (status == "inactive")
                            {
                                <span class="badge-status inactive">Inactive</span>
                            }
                            else
                            {
                                <span class="badge-status active">Active</span>
                            }
                        </td>
                        <td>@m.JoinedAt?.ToString("yyyy-MM-dd")</td>
                        <td class="text-end pe-4">
                            <button type="button"
                                    class="btn btn-outline-primary btn-edit-member"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editMemberModal"
                                    data-full-name="@m.FullName"
                                    
                                    data-department="@m.Department"
                                    data-role="@m.Role"
                                    data-status="@m.Status"
                                    data-user-id="@m.UserId">
                                Sửa
                            </button>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<!-- Phân trang -->
@if (Model.TotalPages > 1)
{
    <nav aria-label="Member pagination" class="mt-3">
        <ul class="pagination pagination-sm">
            @{
                var prevDisabled = Model.Page <= 1 ? "disabled" : "";
                var nextDisabled = Model.Page >= Model.TotalPages ? "disabled" : "";
            }

            <li class="page-item @prevDisabled">
                <a class="page-link"
                   asp-action="Details"
                   asp-controller="Clubs"
                   asp-route-id="@Model.Club.ClubId"
                   asp-route-search="@Model.Search"
                   asp-route-roleFilter="@Model.RoleFilter"
                   asp-route-statusFilter="@Model.StatusFilter"
                   asp-route-page="@(Model.Page - 1)">
                    «
                </a>
            </li>

            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                var active = i == Model.Page ? "active" : "";
                <li class="page-item @active">
                    <a class="page-link"
                       asp-action="Details"
                       asp-controller="Clubs"
                       asp-route-id="@Model.Club.ClubId"
                       asp-route-search="@Model.Search"
                       asp-route-roleFilter="@Model.RoleFilter"
                       asp-route-statusFilter="@Model.StatusFilter"
                       asp-route-page="@i">
                        @i
                    </a>
                </li>
            }

            <li class="page-item @nextDisabled">
                <a class="page-link"
                   asp-action="Details"
                   asp-controller="Clubs"
                   asp-route-id="@Model.Club.ClubId"
                   asp-route-search="@Model.Search"
                   asp-route-roleFilter="@Model.RoleFilter"
                   asp-route-statusFilter="@Model.StatusFilter"
                   asp-route-page="@(Model.Page + 1)">
                    »
                </a>
            </li>
        </ul>
    </nav>
}

<!-- MODAL CẬP NHẬT THÀNH VIÊN -->
<div class="modal fade" id="editMemberModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content edit-member-modal">
            <div class="edit-member-header">
                <h5>Cập nhật hồ sơ thành viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form method="post" asp-action="UpdateMember" asp-controller="Clubs">
                @Html.AntiForgeryToken()
                <div class="edit-member-body">
                    <div class="edit-member-card">
                        <div class="edit-member-avatar" id="editMemberAvatar">M</div>
                        <div>
                            <div class="edit-member-name" id="editMemberName">Tên thành viên</div>
                            <div class="edit-member-meta">
                                MSSV: <span id="editMemberStudentCode">---</span> |
                                <span id="editMemberDepartment">---</span>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="ClubId" value="@Model.Club.ClubId" />
                    <input type="hidden" name="UserId" id="editMemberUserId" />

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Vai trò</label>
                            <select class="form-select" name="Role" id="editMemberRole">
                                <option value="Leader">Leader</option>
                                <option value="Treasurer">Treasurer</option>
                                <option value="Member">Member</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Trạng thái</label>
                            <select class="form-select" name="Status" id="editMemberStatus">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Banned">Banned</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="edit-member-footer">
                    <button type="button" class="btn-danger-link">
                        Xóa/Ban thành viên
                    </button>

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            Hủy
                        </button>
                        <button type="submit" class="btn btn-dark">
                            Lưu thay đổi
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var editMemberModal = document.getElementById('editMemberModal');

        if (!editMemberModal) return;

        editMemberModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            if (!button) return;

            var fullName = button.getAttribute('data-full-name') || '';
            var studentCode = button.getAttribute('data-student-code') || '';
            var department = button.getAttribute('data-department') || '';
            var role = button.getAttribute('data-role') || '';
            var status = button.getAttribute('data-status') || '';
            var userId = button.getAttribute('data-user-id') || '';

            var avatarChar = 'M';
            if (fullName && fullName.trim().length > 0) {
                avatarChar = fullName.trim()[0].toUpperCase();
            }

            document.getElementById('editMemberAvatar').textContent = avatarChar;
            document.getElementById('editMemberName').textContent = fullName || 'Thành viên';
            document.getElementById('editMemberStudentCode').textContent = studentCode || '---';
            document.getElementById('editMemberDepartment').textContent = department || '---';

            document.getElementById('editMemberRole').value = role || 'Member';

            if (status === 'Inactive' || status === 'inactive') {
                document.getElementById('editMemberStatus').value = 'Inactive';
            } else if (status === 'Banned' || status === 'banned') {
                document.getElementById('editMemberStatus').value = 'Banned';
            } else {
                document.getElementById('editMemberStatus').value = 'Active';
            }

            document.getElementById('editMemberUserId').value = userId;
        });
    });
</script>
